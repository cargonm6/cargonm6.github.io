<!DOCTYPE html>
<html lang="es">
    <head>
        <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/2097/2097055.png" />
        <style>
            body {
                width: calc(100% - 80px);
                margin-left: 40px;
            }
        </style>
    </head>
    <body>
        <!-- Controles superiores -->
        <table>
            <tr>
                <td>
                    <select id="modulo">
                        <option value="example">Ejemplo</option>
                        <option value="par_25">Planificación y Administración de Redes</option>
                        <option value="inp_25" selected>Introducción a la Nube Pública</option>
                        <option value="eso4_25">4.º ESO</option>
                    </select>
                </td>
                <td><button id="copiarBtn">COPIAR</button></td>
                <td><button onclick="toggleDetalles(false)">&gt; &lt; Colapsar todo</button></td>
                <td><button onclick="toggleDetalles(true)">&lt; &gt; Expandir todo</button></td>
            </tr>
        </table>

        <!-- Contenedor de tareas + calendario -->
        <div id="supercontainer">
            <table style="font-size: small; width: 100%">
                <tr>
                    <td style="vertical-align: top">
                        <div id="container"></div>
                    </td>
                    <td style="vertical-align: top">
                        <div id="calendar-container" style="margin-top: 10px; margin-left: 10px; text-align: center"></div>
                    </td>
                </tr>
            </table>
        </div>

        <textarea id="codigo"></textarea>

        <script>
            /* ──────────────────────────────── VARIABLES GLOBALES ──────────────────────────────── */

            let tareas_calendario = [];
            let alumnos = null;
            let unidades = null;
            let tareas = null;

            const categoria_ex = ["Exámenes", "Pruebas"];
            const categoria_tr = ["Trabajos", ""];
            const categoria_co = ["Complementos", "Participación"];

            /* ──────────────────────────────── UTILIDADES ──────────────────────────────── */

            const hoy = () => {
                const f = new Date();
                return `${String(f.getDate()).padStart(2, "0")}/${String(f.getMonth() + 1).padStart(2, "0")}/${f.getFullYear()}`;
            };

            const parseFecha = (f) => new Date(f.split("/").reverse().join("-"));
            const cmpFecha = (a, b) => parseFecha(a) - parseFecha(b);

            const fetchJSON = async (file) => {
                try {
                    const r = await fetch(file);
                    if (!r.ok) throw new Error("Error en fetch");
                    return await r.json();
                } catch (e) {
                    console.error("Error leyendo JSON:", e);
                    return null;
                }
            };

            const toggleDetalles = (expandir) => document.querySelectorAll("details").forEach((d) => (d.open = expandir));

            /* ──────────────────────────────── TABLA DE TAREAS ──────────────────────────────── */

            function generarFila(item, unidad) {
                const totalUsuarios = item.usuarios || alumnos;
                const porcentaje = ((100 * item.entregas) / totalUsuarios).toFixed(1);

                let estado;

                if (item.titulo.startsWith("Visita") || categoria_ex.includes(item.categoria)) {
                    estado = item.f_limite;
                } else if (item.corregido === "Corregido") {
                    estado = "Cerrada";
                } else if (cmpFecha(hoy(), item.f_entrega) <= 0) {
                    estado = "En plazo";
                } else if (cmpFecha(hoy(), item.f_limite) <= 0) {
                    estado = "Fuera de plazo";
                } else {
                    estado = "Cerrada";
                }

                const colorCategoria = categoria_co.includes(item.categoria) ? "green" : categoria_ex.includes(item.categoria) ? "firebrick" : "dodgerblue";

                const colorEstado = categoria_ex.includes(item.categoria) ? "inherit" : estado === "Fuera de plazo" ? "firebrick" : estado === "En plazo" ? "green" : "inherit";

                const tituloTarea = item.numero === "" ? item.titulo : `${unidad !== "x" ? item.unidad + "." : ""}${item.numero}. ${item.titulo}`;

                const tooltip =
                    categoria_co.includes(item.categoria) && item.titulo.startsWith("Visita")
                        ? "La visita se celebrará el día indicado"
                        : categoria_ex.includes(item.categoria)
                        ? "El examen se celebrará el día indicado"
                        : item.f_entrega === item.f_limite
                        ? "Fecha límite: " + item.f_limite
                        : `Fecha de entrega: ${item.f_entrega}\nFecha límite: ${item.f_limite}`;

                return `
                <tr style="border-bottom:1px dashed #006444; background:${item.corregido !== "Corregido" ? "#bbded6" : "initial"}; text-align:center;">
                    <td style="text-align:left;">
                        <a href="${item.url}">
                            ${tituloTarea}
                            <img src="https://cdn-icons-png.flaticon.com/512/25/25284.png" style="height:12px;">
                        </a>
                    </td>
                    <td style="color:${colorCategoria};">${item.categoria}</td>
                    <td style="text-align:left;">
                        <progress value="${item.entregas}" max="${totalUsuarios}" title="${porcentaje}%"></progress>
                        ${item.entregas}/${totalUsuarios}
                    </td>
                    <td style="color:${colorEstado}; cursor:help;" title="${tooltip}">${estado}</td>
                    <td style="color:${item.corregido === "En curso" ? "dodgerblue" : "inherit"}">
                        ${estado === "Cerrada" || item.corregido === "Corregido" ? item.corregido : ""}
                    </td>
                </tr>`;
            }

            function generarTabla(tareasPorUnidad) {
                return Object.entries(tareasPorUnidad)
                    .map(([unidad, items]) => {
                        const corregidos = items.every((i) => i.corregido === "Corregido");

                        const filas = items.map((item) => generarFila(item, unidad)).join("");

                        return `
                    <details ${corregidos ? "" : "open"}>
                        <summary style="cursor:pointer;">
                            <b>${unidad !== "x" ? "UP " + unidad + ". " : ""}${unidades[unidad]}</b>
                            <span style="color:#006444;">${corregidos ? " (finalizado)" : ""}</span>
                        </summary><br>

                        <table style="width:100%; border-collapse:collapse">
                            <thead>
                                <tr style="border-bottom:2px solid #006444; text-align:center;">
                                    <th style="width:30%; color:#006444;">Tarea</th>
                                    <th style="width:20%; color:#006444;">Categoría</th>
                                    <th style="width:20%; color:#006444;">Entregas</th>
                                    <th style="width:15%; color:#006444;">Estado</th>
                                    <th style="width:15%; color:#006444;">Valoración</th>
                                </tr>
                            </thead>
                            <tbody>${filas}</tbody>
                        </table>
                    </details><br>`;
                    })
                    .join("");
            }

            function crearDetalles(tareas) {
                const cont = document.getElementById("container");
                cont.innerHTML = `
                <p style="text-align:right; font-style:italic;">
                    Última actualización: ${hoy()}
                </p>`;

                const tareasPorUnidad = tareas.reduce((acc, t) => {
                    (acc[t.unidad] ||= []).push(t);
                    return acc;
                }, {});

                cont.innerHTML += generarTabla(tareasPorUnidad);
            }

            /* ──────────────────────────────── COPIAR HTML ──────────────────────────────── */

            document.getElementById("copiarBtn").addEventListener("click", () => {
                const contenido = document.getElementById("supercontainer").innerHTML;
                const scriptCalendario = document.getElementById("script_calendario")?.innerHTML || "";
                const codigo = document.getElementById("codigo").value;

                const texto = `${contenido}\n\n<script>\n${codigo}\n${scriptCalendario}\n<\/script>`;

                const tmp = document.createElement("textarea");
                tmp.value = texto;
                document.body.appendChild(tmp);
                tmp.select();
                document.execCommand("copy");
                tmp.remove();

                alert("¡Contenido copiado al portapapeles!");
            });

            /* ──────────────────────────────── RECARGAR MÓDULO ──────────────────────────────── */

            document.getElementById("modulo").addEventListener("change", reload_window);

            async function reload_window() {
                const modulo = document.getElementById("modulo").value;
                const data = await fetchJSON(`./moodle_tasks/${modulo}.json`);

                if (!data) return;

                alumnos = data.module.students;
                unidades = data.module.chapters;
                tareas = data.tasks;

                crearDetalles(tareas);

                tareas_calendario = tareas.map((t) => ({
                    unidad: t.unidad,
                    numero: t.numero,
                    titulo: t.titulo,
                    categoria: t.categoria,
                    f_entrega: t.f_entrega,
                }));

                document.getElementById("codigo").value =
                    "tareas_calendario = " +
                    JSON.stringify(tareas_calendario, null, 4)
                        .replace(/\"([^(\")"]+)\":/g, "$1:")
                        .replace(/\"/g, "'") +
                    ";";

                generarCalendarioHTML(tareas_calendario);
            }

            window.onload = reload_window;
        </script>

        <!-- ──────────────────────────────── CALENDARIO ──────────────────────────────── -->

        <script id="script_calendario">
            window.categoria_ex = window.categoria_ex || ["Exámenes", "Pruebas"];
            window.categoria_tr = window.categoria_tr || ["Trabajos", ""];
            window.categoria_co = window.categoria_co || ["Complementos", "Participación"];
            window.festivos = [
                "09/10/2025",
                "10/10/2025",
                "08/12/2025",
                "23/12/2025",
                "24/12/2025",
                "25/12/2025",
                "26/12/2025",
                "27/12/2025",
                "28/12/2025",
                "29/12/2025",
                "30/12/2025",
                "31/12/2025",
                "01/01/2026",
                "02/01/2026",
                "03/01/2026",
                "04/01/2026",
                "05/01/2026",
                "06/01/2026",
                "17/03/2026",
                "18/03/2026",
                "19/03/2026",
                "02/04/2026",
                "03/04/2026",
                "04/04/2026",
                "05/04/2026",
                "06/04/2026",
                "07/04/2026",
                "08/04/2026",
                "09/04/2026",
                "10/04/2026",
                "11/04/2026",
                "12/04/2026",
                "13/04/2026",
                "01/05/2026",
            ];

            function generarCalendario(events, month, year) {
                const hoyStr = (() => {
                    const d = new Date();
                    return `${String(d.getDate()).padStart(2, "0")}/${String(d.getMonth() + 1).padStart(2, "0")}/${d.getFullYear()}`;
                })();

                const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const dias = ["L", "M", "X", "J", "V", "S", "D"];

                let html = `<b>${meses[month]} ${year}</b>`;
                html += `<table style="width:500px; margin:10px auto; text-align:center; border-collapse:collapse">`;
                html += `<tr>${dias.map((d) => `<th style="border:1px solid #ccc;">${d}</th>`).join("")}</tr>`;

                const primerDia = (new Date(year, month, 1).getDay() + 6) % 7;
                const diasMes = new Date(year, month + 1, 0).getDate();

                let dia = 1;
                for (let r = 0; r < 6; r++) {
                    html += "<tr>";
                    for (let c = 0; c < 7; c++) {
                        if ((r === 0 && c < primerDia) || dia > diasMes) {
                            html += `<td style="border:1px solid #ccc; height:80px; width: calc(100% / 7)"></td>`;
                        } else {
                            const f = `${String(dia).padStart(2, "0")}/${String(month + 1).padStart(2, "0")}/${year}`;
                            const eventos = events.filter((e) => e.f_entrega === f);

                            let inner = `<div>${dia}</div>`;
                            if (eventos.length) {
                                inner += `<ul style="list-style:none; padding:0; margin:2px;">`;
                                eventos.forEach((ev) => {
                                    const col = categoria_co.includes(ev.categoria) ? "green" : categoria_ex.includes(ev.categoria) ? "firebrick" : "dodgerblue";

                                    inner += `<li style="background:${col}; color:white; padding:2px; border-radius:3px; margin-bottom:2px;">
                                    ${ev.numero ? ev.unidad + "." + ev.numero : ""} ${ev.titulo}
                                </li>`;
                                });
                                inner += `</ul>`;
                            }

                            const borde = f === hoyStr ? "3px solid orange" : "1px solid #ccc";
                            const esFestivo = window.festivos.includes(f);
                            const fondoFestivo = esFestivo ? "grey" : "white"; // color suave

                            html += `<td style="border:${borde}; background:${fondoFestivo}; height:80px; width: calc(100% / 7); vertical-align:top;">${inner}</td>`;
                            dia++;
                        }
                    }
                    html += "</tr>";
                    if (dia > diasMes) break;
                }

                html += "</table>";
                return html;
            }

            function generarCalendarioHTML(tareas) {
                const cont = document.getElementById("calendar-container");
                let hoy = new Date();
                let mes = hoy.getMonth();
                let año = hoy.getFullYear();

                cont.innerHTML = `
                <button id="prevMonth">&lt; Mes anterior</button>
                <button id="nextMonth">Mes siguiente &gt;</button>
                <div id="calendarContent" style="text-align:center; padding-top:20px"></div>`;

                const render = () => (document.getElementById("calendarContent").innerHTML = generarCalendario(tareas, mes, año));

                document.getElementById("prevMonth").onclick = () => {
                    mes--;
                    if (mes < 0) {
                        mes = 11;
                        año--;
                    }
                    render();
                };

                document.getElementById("nextMonth").onclick = () => {
                    mes++;
                    if (mes > 11) {
                        mes = 0;
                        año++;
                    }
                    render();
                };

                render();
            }

            generarCalendarioHTML(tareas_calendario);
        </script>
    </body>
</html>
