<!DOCTYPE html>
<html lang="es">
    <head>
        <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/2097/2097055.png" />
    </head>
    <body style="width: calc(100% - 80px); margin-left: 40px">
        <table>
            <tr>
                <td>
                    <select id="modulo">
                        <option value="example">Ejemplo</option>
                        <option value="par_25">Planificación y Administración de Redes</option>
                        <option value="inp_25" selected>Introducción a la Nube Pública</option>
                        <option value="eso4_25">4.º ESO</option>
                    </select>
                </td>
                <td><button id="copiarBtn">COPIAR</button></td>
                <td><button onclick="colapsarDetalles()">&gt; &lt; Colapsar todo</button></td>
                <td><button onclick="colapsarDetalles(true)">&lt; &gt; Expandir todo</button></td>
            </tr>
        </table>
        <div id="supercontainer">
            <table style="font-size: small; width: 100%">
                <tr>
                    <td style="vertical-align: top"><div id="container"></div></td>
                    <td style="vertical-align: top"><div id="calendar-container" style="margin-top: 10px; margin-left: 10px; text-align: center"></div></td>
                </tr>
            </table>
        </div>

        <textarea id="codigo" style="font-family: 'Courier New', Courier, monospace; font-size: small; width: calc(100% - 40px); height: 120px"></textarea>

        <script>
            tareas_calendario = [];
            var alumnos = null;
            var unidades = null;
            var tareas = null;

            var categoria_ex = ["Exámenes", "Pruebas"];
            var categoria_tr = ["Trabajos", ""];
            var categoria_co = ["Complementos", "Participación"];

            async function read_json(file) {
                try {
                    const response = await fetch(file);
                    if (!response.ok) throw new Error("Network response was not ok");
                    return await response.json();
                } catch (error) {
                    console.error("Hubo un problema con la lectura del JSON:", error);
                    return null;
                }
            }

            function colapsarDetalles(expandir = false) {
                const detalles = document.querySelectorAll("details");
                detalles.forEach((detalle) => {
                    if (expandir) {
                        detalle.open = true; // Colapsar el detalle
                    } else {
                        detalle.open = false;
                    }
                });
            }

            function obtenerFechaActual() {
                const fechaActual = new Date();
                return `${String(fechaActual.getDate()).padStart(2, "0")}/${String(fechaActual.getMonth() + 1).padStart(2, "0")}/${fechaActual.getFullYear()}`;
            }

            function compararFechas(fecha1, fecha2) {
                return new Date(fecha1.split("/").reverse().join("-")) - new Date(fecha2.split("/").reverse().join("-"));
            }

            function generarTabla(tareasPorUnidad) {
                return Object.entries(tareasPorUnidad)
                    .map(([unidad, items]) => {
                        const corregidos = items.every((item) => item.corregido === "Corregido");

                        const filas = items
                            .map((item) => {
                                let estado = null;
                                if (item.corregido === "Corregido") {
                                    estado = "Cerrada";
                                } else {
                                    estado = compararFechas(obtenerFechaActual(), item.f_entrega) <= 0 ? "En plazo" : compararFechas(obtenerFechaActual(), item.f_limite) <= 0 ? "Fuera de plazo" : "Cerrada";
                                }

                                return `
                        <tr style="border-bottom: 1px dashed #006444ff; text-align: center; background-color: ${item.corregido !== "Corregido" ? "#bbded6" : "initial"}">
                            <td style="text-align: left">
                                <a href="${item.url}">
                                    ${
                                        item.numero === "" ? item.titulo : `${unidad != "x" ? item.unidad + "." : ""}${item.numero}.&nbsp;${item.titulo}`
                                    }&nbsp;<img src="https://cdn-icons-png.flaticon.com/512/25/25284.png" style="height:12px">
                                </a>
                            </td>
                            <td style="text-align: center; color: ${categoria_co.includes(item.categoria) ? "green" : categoria_ex.includes(item.categoria) ? "firebrick" : "dodgerblue"}">
                                ${item.categoria}
                            </td>
                            <td style="text-align: left">
                                <progress style="cursor:help" value="${item.entregas}" max="${item.usuarios == "" ? alumnos : item.usuarios}" title="${
                                    ((100 * item.entregas) / (item.usuarios == "" ? alumnos : item.usuarios)).toFixed(1).toString() + " %"
                                }"></progress> ${item.entregas}/${item.usuarios == "" ? alumnos : item.usuarios}
                            </td>
                            <td style="cursor:help; text-align: center; color: ${categoria_ex.includes(item.categoria) ? "inherit" : estado === "Fuera de plazo" ? "firebrick" : estado === "En plazo" ? "green" : "inherit"}" 
                                title="${
                                    categoria_co.includes(item.categoria) && item.titulo.startsWith("Visita")
                                        ? "La visita se celebrará el día indicado"
                                        : categoria_ex.includes(item.categoria)
                                        ? "El examen se celebrará el día indicado"
                                        : item.f_entrega === item.f_limite
                                        ? "Fecha límite: " + item.f_limite
                                        : "Fecha de entrega: " + item.f_entrega + "\nFecha límite: " + item.f_limite
                                }">
                                ${categoria_co.includes(item.categoria) && item.titulo.startsWith("Visita") ? item.f_limite : categoria_ex.includes(item.categoria) ? item.f_limite : estado}
                            </td>
                            <td style="text-align: center; color: ${item.corregido === "En curso" ? "dodgerblue" : "inherit"}">
                                ${estado === "Cerrada" ? item.corregido : ""}
                            </td>
                        </tr>`;
                            })
                            .join("");

                        return `
                    <details ${corregidos ? "" : "open"}>
                        <summary style="cursor: pointer"><b>${unidad != "x" ? "UP " + unidad + ". " : ""}${unidades[unidad]}</b><span style="color:#006444ff">${corregidos ? " (finalizado)" : ""}</span></summary><br/>
                        <table style="width: 100%; border-collapse: collapse">
                            <thead>
                                <tr style="border-bottom: 2px solid #006444ff; text-align: center">
                                    <th style="width: calc(100% * 0.3); color: #006444ff">Tarea</th>
                                    <th style="width: calc(100% * 0.2); color: #006444ff">Categoría</th>
                                    <th style="width: calc(100% * 0.2); color: #006444ff">Entregas</th>
                                    <th style="width: calc(100% * 0.15); color: #006444ff">Estado</th>
                                    <th style="width: calc(100% * 0.15); color: #006444ff">Valoración</th>
                                </tr>
                            </thead>
                            <tbody>${filas}</tbody>
                        </table>
                    </details><br/>`;
                    })
                    .join("");
            }

            function crearDetalles(tareas) {
                const contenedor = document.getElementById("container");
                contenedor.innerHTML = "";

                const p_fecha = document.createElement("p");
                p_fecha.style.textAlign = "right";
                p_fecha.style.fontStyle = "italic";
                p_fecha.textContent = "Última actualización: " + obtenerFechaActual();
                contenedor.appendChild(p_fecha);

                const tareasPorUnidad = tareas.reduce((acc, item) => {
                    if (!acc[item.unidad]) acc[item.unidad] = [];
                    acc[item.unidad].push(item);
                    return acc;
                }, {});

                contenedor.innerHTML += generarTabla(tareasPorUnidad);
            }

            document.getElementById("copiarBtn").addEventListener("click", function () {
                // Obtener el contenido HTML que queremos copiar
                const contenido = document.getElementById("supercontainer").innerHTML;

                // Obtener el script calendario
                const scriptElemento = document.getElementById("script_calendario");
                const codigo = document.getElementById("codigo").innerHTML;
                let scriptContenido = scriptElemento ? scriptElemento.innerHTML : "";

                // Combinar contenido + script
                const todoContenido = contenido + "\n\n<script>\n" + codigo + "\n" + scriptContenido + "\n<\/script>";
                console.log(todoContenido);

                // Crear textarea temporal para copiar
                const textarea = document.createElement("textarea");
                textarea.value = todoContenido;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);

                alert("¡Contenido copiado al portapapeles!");
            });

            document.getElementById("modulo").addEventListener("change", function () {
                reload_window();
            });

            async function reload_window() {
                const modulo = document.getElementById("modulo").value;
                let json_file = "./moodle_tasks/" + modulo + ".json";
                // let json_file = "./" + modulo + ".json";

                json_file = await read_json(json_file);

                if (json_file) {
                    alumnos = json_file["module"]["students"];
                    unidades = json_file["module"]["chapters"];
                    tareas = json_file["tasks"];

                    crearDetalles(tareas);

                    // ---

                    const tareasResumidas = tareas.map((item) => ({
                        unidad: item.unidad,
                        numero: item.numero,
                        titulo: item.titulo,
                        categoria: item.categoria,
                        f_entrega: item.f_entrega,
                    }));

                    tareas_calendario = tareasResumidas;

                    document.getElementById("codigo").innerHTML =
                        "tareas_calendario = " +
                        JSON.stringify(tareasResumidas, null, 4)
                            .replace(/\"([^(\")"]+)\":/g, "$1:") // quita comillas de las claves
                            .replace(/\"/g, "'") +
                        ";";
                    generarCalendarioHTML(tareas_calendario);

                    // ---
                }
            }

            window.onload = async function () {
                reload_window();
            };
        </script>

        <script id="script_calendario">
            var categoria_ex = ["Exámenes", "Pruebas"];
            var categoria_tr = ["Trabajos", ""];
            var categoria_co = ["Complementos", "Participación"];
            
            function generarCalendario(events = [], month, year) {
                let fechaMarcada = new Date();
                fechaMarcada = `${String(fechaMarcada.getDate()).padStart(2, "0")}/${String(fechaMarcada.getMonth() + 1).padStart(2, "0")}/${fechaMarcada.getFullYear()}`;

                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const daysOfWeek = ["L", "M", "X", "J", "V", "S", "D"];

                let html = `<b style="text-align:center">${monthNames[month]} ${year}</b>`;
                html += `<table style="border-collapse:collapse; width:500px; margin:0 auto; text-align:center;">
<tr>${daysOfWeek.map((d) => `<th style="padding:2px; border:1px solid #ccc; width:14.28%;">${d}</th>`).join("")}</tr>`;

                const firstDayJS = new Date(year, month, 1).getDay(); // domingo=0
                const firstDay = (firstDayJS + 6) % 7; // lunes=0
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let day = 1;

                for (let row = 0; row < 6; row++) {
                    let rowHtml = "<tr>";
                    for (let col = 0; col < 7; col++) {
                        if ((row === 0 && col < firstDay) || day > daysInMonth) {
                            rowHtml += `<td style="padding:2px; border:1px solid #ccc; height:80px; vertical-align:top;"></td>`;
                        } else {
                            const dateStr = `${String(day).padStart(2, "0")}/${String(month + 1).padStart(2, "0")}/${year}`;
                            let cellContent = `<div>${day}</div>`;

                            const dayEvents = (events || []).filter((e) => e.f_entrega === dateStr);
                            if (dayEvents.length > 0) {
                                cellContent += `<ul style="padding-left:2px; margin:2px 0 0 0; list-style:none; font-size:0.8em;">`;
                                dayEvents.forEach((ev) => {
                                    let background = `${categoria_co.includes(ev.categoria) ? "green" : categoria_ex.includes(ev.categoria) ? "firebrick" : "dodgerblue"}`;
                                    cellContent += `<li style="background:${background}; color:white; margin-bottom:2px; border-radius:3px; padding:2px;">
                                ${ev.numero ? ev.unidad + "." + ev.numero : ""} ${ev.titulo}</li>`;
                                });
                                cellContent += `</ul>`;
                            }

                            // Marcamos la celda según la fecha interna
                            let borderStyle = dateStr === fechaMarcada ? "3px solid orange" : "1px solid #ccc";
                            rowHtml += `<td style="padding:5px; border:${borderStyle}; vertical-align:top; text-align:left; width:14.28%; height:80px;">${cellContent}</td>`;
                            day++;
                        }
                    }
                    rowHtml += "</tr>";
                    html += rowHtml;
                    if (day > daysInMonth) break;
                }

                html += "</table>";
                return html;
            }

            function generarCalendarioHTML(tareas) {
                const container = document.getElementById("calendar-container");
                let today = new Date();
                let currentMonth = today.getMonth();
                let currentYear = today.getFullYear();

                let html = `<button id="prevMonth" style="margin-right:10px;">&lt; Mes anterior</button>
                <button id="nextMonth">Mes siguiente &gt;</button>
                <div id="calendarContent" style="margin-top:10px;"></div>`;

                container.innerHTML = html;
                const calendarContent = container.querySelector("#calendarContent");

                function render() {
                    calendarContent.innerHTML = generarCalendario(tareas || [], currentMonth, currentYear);
                }

                container.querySelector("#prevMonth").addEventListener("click", () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    render();
                });

                container.querySelector("#nextMonth").addEventListener("click", () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    render();
                });

                render();
            }

            generarCalendarioHTML(tareas_calendario);
        </script>
    </body>
</html>
